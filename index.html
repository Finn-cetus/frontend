<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CourseHub Infinity - N∆°i tri th·ª©c l√† v√¥ h·∫°n v√† mi·ªÖn ph√≠</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --accent-neon: #00ffff;
            --accent-purple: #9d4edd;
            --accent-green: #39ff14;
            --text-primary: #ffffff;
            --text-secondary: #b8b8b8;
            --border-glow: rgba(0, 255, 255, 0.3);
        }

        body {
            font-family: 'Fira Code', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><text y="15" font-size="12" fill="%2300ffff">_</text></svg>'), auto;
            overflow-x: hidden;
        }

        .cursor-pointer {
            cursor: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><text y="15" font-size="14" fill="%2300ffff">‚ñ∂</text></svg>'), pointer;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--accent-neon);
            animation: float 10s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) translateX(0px); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(100px); opacity: 0; }
        }

        header {
            background: rgba(26, 26, 46, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-glow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        nav {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-neon);
            text-shadow: 0 0 10px var(--accent-neon);
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary {
            background: linear-gradient(45deg, var(--accent-purple), var(--accent-neon));
            color: white;
            border: 1px solid transparent;
        }
        .btn-secondary {
            background: transparent;
            color: var(--accent-neon);
            border: 1px solid var(--accent-neon);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.3);
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .hero h1 {
            font-size: 3rem;
        }

        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .course-card {
            background: var(--bg-card);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 255, 0.1);
            transition: all 0.4s ease;
            position: relative;
        }
        .course-card:hover {
            transform: perspective(1000px) translateY(-10px);
            border-color: var(--accent-neon);
            box-shadow: 0 20px 40px rgba(0, 255, 255, 0.2);
        }

        .course-image {
            height: 180px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-neon));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
        }

        .course-content { padding: 1.5rem; }
        .course-title { font-size: 1.2rem; margin-bottom: 0.5rem; }
        .course-author { color: var(--accent-neon); font-size: 0.9rem; margin-bottom: 1rem; }
        .course-stats { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
        .course-category { background: rgba(0, 255, 255, 0.1); color: var(--accent-neon); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            border: 1px solid var(--accent-neon);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem; right: 1rem;
            background: none; border: none;
            color: var(--accent-neon);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
        }
        
        .auth-tabs { display: flex; margin-bottom: 2rem; }
        .auth-tab {
            flex: 1; padding: 1rem; background: transparent;
            border: none; color: var(--text-secondary);
            border-bottom: 2px solid transparent; cursor: pointer;
        }
        .auth-tab.active { color: var(--accent-neon); border-bottom-color: var(--accent-neon); }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        
        /* Account Modal & Contributors List Styles */
        .account-info, .contributors-list { margin-top: 1rem; }
        .account-info p { margin-bottom: 0.5rem; font-size: 1.1rem; }
        .account-info strong { color: var(--accent-neon); }
        .contribution-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
        .contribution-list li {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .contributors-list ol { padding-left: 2rem; }
        .contributors-list li {
            font-size: 1.2rem;
            padding: 0.5rem;
            color: var(--text-secondary);
        }
        .contributors-list li strong { color: var(--accent-neon); }
        .contributors-list li:first-child { color: #ffd700; font-weight: bold; } /* Gold */
        .contributors-list li:nth-child(2) { color: #c0c0c0; } /* Silver */
        .contributors-list li:nth-child(3) { color: #cd7f32; } /* Bronze */


        @media (max-width: 768px) {
            nav { flex-direction: column; gap: 1rem; }
            .hero h1 { font-size: 2rem; }
            .course-grid { grid-template-columns: 1fr; }
        }

    </style>
</head>
<body>
    <div class="bg-animation" id="bgAnimation"></div>

    <header>
        <nav>
            <div class="logo">CourseHub‚àû</div>
            <div class="nav-buttons">
                <button class="btn btn-secondary cursor-pointer" id="contributorsBtn">
                    <i class="fas fa-trophy"></i> B·∫£ng vinh danh
                </button>
                <button class="btn btn-secondary cursor-pointer" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
                </button>
                <button class="btn btn-primary cursor-pointer" id="uploadBtn">
                    <i class="fas fa-plus"></i> ƒêƒÉng t·∫£i kh√≥a h·ªçc
                </button>
            </div>
        </nav>
    </header>

    <main>
        <section class="hero" style="text-align: center; margin-bottom: 4rem;">
            <h1>CourseHub Infinity</h1>
            <p>üöÄ N∆°i tri th·ª©c l√† v√¥ h·∫°n v√† mi·ªÖn ph√≠ üöÄ</p>
        </section>

        <section>
            <h2 style="font-size: 2rem; margin-bottom: 2rem; color: var(--accent-neon);">
                <i class="fas fa-rocket"></i> Kh√°m ph√° c√°c kh√≥a h·ªçc
            </h2>
            <div class="course-grid" id="courseGrid"></div>
            <div id="paginationControls" style="text-align: center; margin: 2rem 0;"></div>
        </section>
    </main>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <button class="modal-close cursor-pointer" id="closeAuthModal">&times;</button>
            <div class="auth-tabs">
                <button class="auth-tab active cursor-pointer" data-tab="login">ƒêƒÉng nh·∫≠p</button>
                <button class="auth-tab cursor-pointer" data-tab="register">ƒêƒÉng k√Ω</button>
            </div>
            <form class="auth-form active" id="loginForm">
                <div class="form-group"><label>Email ho·∫∑c t√™n ƒëƒÉng nh·∫≠p</label><input type="text" required></div>
                <div class="form-group"><label>M·∫≠t kh·∫©u</label><input type="password" required></div>
                <button type="submit" class="btn btn-primary cursor-pointer" style="width: 100%;">ƒêƒÉng nh·∫≠p</button>
            </form>
            <form class="auth-form" id="registerForm">
                <div class="form-group"><label>T√™n ƒëƒÉng nh·∫≠p</label><input type="text" required></div>
                <div class="form-group"><label>Email</label><input type="email" required></div>
                <div class="form-group"><label>M·∫≠t kh·∫©u</label><input type="password" required></div>
                <div class="form-group"><label>X√°c nh·∫≠n m·∫≠t kh·∫©u</label><input type="password" required></div>
                <button type="submit" class="btn btn-primary cursor-pointer" style="width: 100%;">ƒêƒÉng k√Ω</button>
            </form>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal" id="uploadModal">
         <div class="modal-content">
            <button class="modal-close cursor-pointer" id="closeUploadModal">&times;</button>
            <h3 style="margin-bottom: 2rem; color: var(--accent-neon);"><i class="fas fa-upload"></i> ƒêƒÉng t·∫£i kh√≥a h·ªçc m·ªõi</h3>
            <form id="uploadForm">
                <div class="form-group"><label>T√™n kh√≥a h·ªçc</label><input type="text" required></div>
                <div class="form-group"><label>Link kh√≥a h·ªçc</label><input type="url" required></div>
                <div class="form-group"><label>Danh m·ª•c</label>
                    <select>
                        <option>Frontend</option><option>Backend</option><option>Mobile</option><option>AI/ML</option><option>DevOps</option><option>Database</option><option>UI/UX</option>
                    </select>
                </div>
                <div class="form-group"><label>M√¥ t·∫£</label><textarea rows="4"></textarea></div>
                <button type="submit" class="btn btn-primary cursor-pointer" style="width: 100%;">ƒêƒÉng t·∫£i</button>
            </form>
        </div>
    </div>
    
    <!-- Account Management Modal -->
    <div class="modal" id="accountModal">
        <div class="modal-content">
            <button class="modal-close cursor-pointer" id="closeAccountModal">&times;</button>
            <h3 style="margin-bottom: 2rem; color: var(--accent-neon);"><i class="fas fa-user-cog"></i> Qu·∫£n l√Ω t√†i kho·∫£n</h3>
            <div id="accountDetails"></div>
        </div>
    </div>
    
    <!-- Top Contributors Modal -->
    <div class="modal" id="contributorsModal">
        <div class="modal-content">
            <button class="modal-close cursor-pointer" id="closeContributorsModal">&times;</button>
            <h3 style="margin-bottom: 2rem; color: var(--accent-neon);"><i class="fas fa-trophy"></i> B·∫£ng vinh danh ng∆∞·ªùi ƒë√≥ng g√≥p</h3>
            <div id="contributorsDetails"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://backend-nyun.onrender.com';
let currentUser = null;
let currentPage = 1;
const limit = 6;

document.addEventListener('DOMContentLoaded', () => {
    // Initial setup
    loadCourses(currentPage);
    setupEventListeners();
    checkLoginStatus();
});

// --- API Abstraction ---
async function fetchData(endpoint, options = {}) {
    try {
        const token = localStorage.getItem('token');
        if (token) {
            options.headers = { ...options.headers, 'x-auth-token': token };
        }
        const response = await fetch(`${API_URL}${endpoint}`, options);
        const data = await response.json();
        if (!response.ok) throw new Error(data.msg || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        return data;
    } catch (error) {
        showNotification(error.message, 'error');
        throw error;
    }
}

// --- Course Rendering ---
async function loadCourses(page) {
    currentPage = page;
    const courseGrid = document.getElementById('courseGrid');
    courseGrid.innerHTML = '<div>ƒêang t·∫£i...</div>';
    try {
        const data = await fetchData(`/api/courses?page=${page}&limit=${limit}`);
        courseGrid.innerHTML = '';
        if (data.courses && data.courses.length > 0) {
            data.courses.forEach(course => courseGrid.appendChild(createCourseCard(course)));
            renderPaginationControls(data.totalPages, data.currentPage);
        } else {
            courseGrid.innerHTML = '<p>Ch∆∞a c√≥ kh√≥a h·ªçc n√†o.</p>';
        }
    } catch (error) {
        courseGrid.innerHTML = `<p>Kh√¥ng th·ªÉ t·∫£i kh√≥a h·ªçc.</p>`;
    }
}

function createCourseCard(course) {
    const card = document.createElement('div');
    card.className = 'course-card';
    
    // --- Verification Ticks ---
    let tick = '';
    if (course.author.role === 'admin') {
        tick = `<i class="fas fa-check-circle verified-tick" style="color: var(--color-admin);" title="Admin"></i>`;
    } else if (course.author.role === 'moderator') {
        tick = `<i class="fas fa-check-circle verified-tick" style="color: var(--color-moderator);" title="Ph√≥ qu·∫£n l√Ω"></i>`;
    }

    // --- Authorization for Actions ---
    let actions = '';
    const isOwner = currentUser && currentUser.id === course.author._id;
    const isAdmin = currentUser && currentUser.role === 'admin';
    const isModerator = currentUser && currentUser.role === 'moderator';
    const isAuthorAdmin = course.author.role === 'admin';

    if (isAdmin || (isModerator && !isAuthorAdmin) || isOwner) {
        actions = `
        <div class="course-card-actions">
            <button class="action-btn cursor-pointer" onclick='openEditModal(${JSON.stringify(course)})'><i class="fas fa-pen"></i></button>
            <button class="action-btn cursor-pointer" onclick="confirmDelete('${course._id}')"><i class="fas fa-trash"></i></button>
        </div>`;
    }

    card.innerHTML = `
        ${actions}
        <div class="course-image cursor-pointer" onclick="window.open('${course.link}', '_blank')"><i class="fas fa-play"></i></div>
        <div class="course-content">
            <h3 class="course-title">${course.title}</h3>
            <p class="course-author">by @${course.author.username} ${tick}</p>
        </div>`;
    return card;
}

// --- UI Updates & Modals ---
function updateUIForLoggedIn(user) {
    currentUser = user;
    const loginBtn = document.getElementById('loginBtn');
    loginBtn.innerHTML = `<i class="fas fa-user"></i> ${user.username}`;
    loginBtn.className = 'btn btn-primary cursor-pointer';
    loginBtn.onclick = openAccountModal;
    if (!document.getElementById('logoutBtn')) {
        const logoutBtn = document.createElement('button');
        logoutBtn.id = 'logoutBtn';
        logoutBtn.className = 'btn btn-secondary cursor-pointer';
        logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t';
        logoutBtn.onclick = handleLogout;
        loginBtn.parentElement.insertBefore(logoutBtn, loginBtn.nextSibling);
    }
}

function updateUIForLoggedOut() {
    currentUser = null;
    const loginBtn = document.getElementById('loginBtn');
    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p';
    loginBtn.className = 'btn btn-secondary cursor-pointer';
    loginBtn.onclick = () => openModal('authModal');
    document.getElementById('logoutBtn')?.remove();
}

async function openAccountModal() {
    openModal('accountModal');
    const detailsDiv = document.getElementById('accountDetails');
    detailsDiv.innerHTML = 'ƒêang t·∫£i th√¥ng tin...';
    try {
        const data = await fetchData('/api/users/me');
        let adminPanel = '';
        if (data.user.role === 'admin') {
            adminPanel = `
                <div class="admin-panel">
                    <h4 style="margin-top: 2rem; margin-bottom: 1rem;">B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</h4>
                    <div id="userListContainer">ƒêang t·∫£i danh s√°ch th√†nh vi√™n...</div>
                </div>`;
        }
        detailsDiv.innerHTML = `
            <div>
                <p><strong>T√™n:</strong> ${data.user.username}</p>
                <p><strong>Email:</strong> ${data.user.email}</p>
                <p><strong>Vai tr√≤:</strong> ${data.user.role}</p>
                <p><strong>ƒê√≥ng g√≥p:</strong> ${data.user.contributionCount} kh√≥a h·ªçc</p>
            </div>
            ${adminPanel}`;
        
        if (data.user.role === 'admin') loadAllUsersForAdmin();

    } catch (error) {
        detailsDiv.innerHTML = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin t√†i kho·∫£n.';
    }
}

async function loadAllUsersForAdmin() {
    const container = document.getElementById('userListContainer');
    try {
        const users = await fetchData('/api/admin/users');
        container.innerHTML = `
            <table>
                <thead>
                    <tr><th>Th√†nh vi√™n</th><th>Vai tr√≤</th><th>H√†nh ƒë·ªông</th></tr>
                </thead>
                <tbody>
                    ${users.map(user => `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.role}</td>
                            <td>
                                ${user.role !== 'admin' ? `
                                    <select onchange="handleUpdateUserRole('${user._id}', this.value)">
                                        <option value="user" ${user.role === 'user' ? 'selected' : ''}>Th√†nh vi√™n</option>
                                        <option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>Ph√≥ qu·∫£n l√Ω</option>
                                    </select>
                                ` : 'Kh√¥ng c√≥'}
                            </td>
                        </tr>`).join('')}
                </tbody>
            </table>`;
    } catch(e) {
        container.innerHTML = 'L·ªói khi t·∫£i danh s√°ch th√†nh vi√™n.';
    }
}

// --- Event Handlers & Actions ---
function handleLogout() {
    localStorage.removeItem('token');
    updateUIForLoggedOut();
    showNotification('B·∫°n ƒë√£ ƒëƒÉng xu·∫•t.', 'info');
}

async function handleUpdateUserRole(userId, newRole) {
    try {
        await fetchData(`/api/admin/users/${userId}/role`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ role: newRole })
        });
        showNotification('C·∫≠p nh·∫≠t vai tr√≤ th√†nh c√¥ng!', 'success');
        loadAllUsersForAdmin(); // Refresh list
    } catch (error) {}
}

function openEditModal(course) {
    document.getElementById('editCourseId').value = course._id;
    document.getElementById('editCourseTitle').value = course.title;
    document.getElementById('editCourseLink').value = course.link;
    document.getElementById('editCourseCategory').value = course.category;
    document.getElementById('editCourseDescription').value = course.description;
    openModal('editCourseModal');
}

async function handleEditCourse(e) {
    e.preventDefault();
    const courseId = document.getElementById('editCourseId').value;
    const courseData = {
        title: document.getElementById('editCourseTitle').value,
        link: document.getElementById('editCourseLink').value,
        category: document.getElementById('editCourseCategory').value,
        description: document.getElementById('editCourseDescription').value,
    };
    try {
        await fetchData(`/api/courses/${courseId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(courseData)
        });
        closeModal('editCourseModal');
        showNotification('C·∫≠p nh·∫≠t kh√≥a h·ªçc th√†nh c√¥ng!', 'success');
        loadCourses(currentPage);
    } catch (error) {}
}

function confirmDelete(courseId) {
    openModal('confirmDeleteModal');
    document.getElementById('confirmDeleteBtn').onclick = () => handleDeleteCourse(courseId);
}

async function handleDeleteCourse(courseId) {
    try {
        await fetchData(`/api/courses/${courseId}`, { method: 'DELETE' });
        closeModal('confirmDeleteModal');
        showNotification('ƒê√£ x√≥a kh√≥a h·ªçc.', 'success');
        loadCourses(currentPage);
    } catch (error) {}
}

// --- Utility Functions ---
function setupEventListeners() {
    // ... (same as previous, plus form submission for edit modal)
    document.getElementById('editCourseForm').addEventListener('submit', handleEditCourse);
    // Bind other modals and buttons here...
}
function checkLoginStatus() {
    const token = localStorage.getItem('token');
    if (token) {
        try {
            const user = JSON.parse(atob(token.split('.')[1])).user;
            updateUIForLoggedIn(user);
        } catch (e) { handleLogout(); }
    } else { updateUIForLoggedOut(); }
}
function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
function showNotification(message, type = 'info') { /* ... */ }
function renderPaginationControls(totalPages, currentPage) { /* ... */ }
// Other handlers (login, register, upload, contributors) remain similar
    </script>
</body>
</html>

